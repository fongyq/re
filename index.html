<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <title>regexp</title>

        <link rel="icon" href="./magnum.ico" type="image/x-icon">

        <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/jsdiff/5.0.0/diff.min.js"></script>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.7.1/styles/github.min.css" />
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css" />
        <script src="https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js"></script> -->

        <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/codemirror.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/mode/perl/perl.min.js"></script>
        <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/codemirror.min.css" />
        <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/theme/abbott.min.css" />
        <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/theme/elegant.min.css" />
        <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/theme/mdn-like.min.css" /> -->
        
        <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>

        <!-- mode -->
        <script src="./codemirror/codemirror-5.65.16/lib/codemirror.js"></script>
        <script src="./codemirror/codemirror-5.65.16/mode/perl/perl.js"></script>
        <script src="./codemirror/codemirror-5.65.16/mode/python/python.js"></script>
        <script src="./codemirror/codemirror-5.65.16/mode/clike/clike.js"></script>
        <script src="./codemirror/codemirror-5.65.16/mode/shell/shell.js"></script>
        <script src="./codemirror/codemirror-5.65.16/mode/sql/sql.js"></script>
        <script src="./codemirror/codemirror-5.65.16/mode/markdown/markdown.js"></script>
        <script src="./codemirror/codemirror-5.65.16/mode/gfm/gfm.js"></script>
        <script src="./codemirror/codemirror-5.65.16/mode/rst/rst.js"></script>
        <script src="./codemirror/codemirror-5.65.16/addon/mode/overlay.js"></script>
        <script src="./codemirror/codemirror-5.65.16/mode/htmlmixed/htmlmixed.js"></script>
        <script src="./codemirror/codemirror-5.65.16/mode/xml/xml.js"></script>
        <script src="./codemirror/codemirror-5.65.16/mode/css/css.js"></script>
        <script src="./codemirror/codemirror-5.65.16/mode/javascript/javascript.js"></script>
        <!-- theme -->
        <link rel="stylesheet" type="text/css" href="./codemirror/codemirror-5.65.16/lib/codemirror.css" >
        <link rel="stylesheet" type="text/css" href="./codemirror/codemirror-5.65.16/theme/abbott.css" >
        <link rel="stylesheet" type="text/css" href="./codemirror/codemirror-5.65.16/theme/elegant.css" >
        <link rel="stylesheet" type="text/css" href="./codemirror/codemirror-5.65.16/theme/eclipse.css" >
        <link rel="stylesheet" type="text/css" href="./codemirror/codemirror-5.65.16/theme/mdn-like.css" >
        <link rel="stylesheet" type="text/css" href="./codemirror/codemirror-5.65.16/theme/darcula.css" >
        <!-- 代码折叠 -->
        <link rel="stylesheet" href="./codemirror/codemirror-5.65.16/addon/fold/foldgutter.css"/>
        <script src="./codemirror/codemirror-5.65.16/addon/fold/foldcode.js"></script>
        <script src="./codemirror/codemirror-5.65.16/addon/fold/foldgutter.js"></script>
        <script src="./codemirror/codemirror-5.65.16/addon/fold/brace-fold.js"></script>
        <script src="./codemirror/codemirror-5.65.16/addon/fold/comment-fold.js"></script>
        <script src="./codemirror/codemirror-5.65.16/addon/fold/indent-fold.js"></script>
        <!-- search -->
        <link rel="stylesheet" href="./codemirror/codemirror-5.65.16/addon/dialog/dialog.css"/>
        <script src="./codemirror/codemirror-5.65.16/addon/dialog/dialog.js"></script>
        <script src="./codemirror/codemirror-5.65.16/addon/search/search.js"></script>
        <script src="./codemirror/codemirror-5.65.16/addon/search/searchcursor.js"></script>
        <script src="./codemirror/codemirror-5.65.16/addon/search/jump-to-line.js"></script>
        <script src="./codemirror/codemirror-5.65.16/addon/search/match-highlighter.js"></script>
        <!-- 全屏模式 -->
        <link rel="stylesheet" href="./codemirror/codemirror-5.65.16/addon/display/fullscreen.css">
        <script src="./codemirror/codemirror-5.65.16/addon/display/fullscreen.js"></script>
        <!-- 括号匹配 -->
        <script src="./codemirror/codemirror-5.65.16/addon/edit/matchbrackets.js"></script>

        <link rel="stylesheet" href="./codemirror/codemirror-5.65.16/addon/scroll/simplescrollbars.css">
        <script src="./codemirror/codemirror-5.65.16/addon/scroll/simplescrollbars.js"></script>

        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.8/clipboard.min.js"></script>
        
        <link rel="stylesheet" href="./custom.css"/>
        
    </head>
    <body>
        <div class="function-container">
            <div class="select-cnt" id="select-cnt"></div>
            <div class="tooltip fa-regular fa-question-circle fa-lg">
                <ul class="tooltiptext">
                    <li>光标位于文本框内，F11 / Ctrl-B 全屏，Esc 退出全屏。</li>
                    <li>光标位于左侧输入框内，Ctrl-F / Cmd-F 搜索，Ctrl-G / Cmd-G 查找下一个，Shift-Ctrl-G / Shift-Cmd-G 查找上一个，Shift-Ctrl-F / Cmd-Option-F 替换，Alt-G 跳到指定行。</li>
                    <li>正则表达式默认设置为 Global & Multiline 模式。</li>
                    <li>在长行换行的情况下，生成行号可能会比较慢，可以关闭换行模式或者关闭行号。换行情况下，编辑器内使用光标选择文本有时会有点 bug。</li>
                    <li> <span class="code">.*</span> 会匹配空字符串，因此对于非空行会有 2 个匹配。可以使用 <span class="code">.+</span> 匹配非空字符串。</li>
                    <li> <span class="code">^$</span> 匹配空行（不含换行符）；<span class="code">$&</span> 表示匹配到的字符串。</li>
                    <li>匹配中文：<span class="code">[\u4e00-\u9fa5]</span>；匹配双字节字符（包括中文）：<span class="code">[^\x00-\xff]</span>。</li>
                    <li> <span class="code">\U$1\U</span> 可以将捕获的第一个匹配转换为全大写，<span class="code">\L$1\L</span> 转换为全小写。</li>
                    <li>参考：
                        <a href="https://regex101.com" target="_blank">https://regex101.com</a>，
                        <a href="https://www.fangyq.cn/docs/regularExpression/01_character.html" target="_blank">https://www.fangyq.cn/docs/regularExpression</a>。
                    </li>
                </ul>
            </div>
            <select id="code-mode" class="selector" style="width: 7.5rem;" onchange="setLangMode(event)" title="编辑器语言">
                <option value="text/plain" selected>Plain</option>
                <option value="text/javascript">JavaScript</option>
                <option value="text/x-csrc">C</option>
                <option value="text/x-c++src">C++</option>
                <option value="text/x-python">Python</option>
                <option value="text/x-java">Java</option>
                <option value="text/x-sh">Shell</option>
                <option value="text/x-sql">SQL</option>
                <option value="text/x-markdown">Markdown</option>
                <option value="text/x-rst">Rst</option>
                <option value="text/html">HTML</option>
                <option value="text/css">CSS</option>
                <option value="text/x-perl">Perl</option>
            </select>
            <select id="code-theme" class="selector" style="width: 6.4rem;" onchange="setTheme(event)" title="编辑器主题">
                <option value="abbott">Abbott</option>
                <option value="darcula">Darcula</option>
                <option value="eclipse" selected>Eclipse</option>
                <option value="elegant">Elegant</option>
                <option value="mdn-like">Mdn-like</option>
            </select>
            <select id="font-size" class="selector" style="width: 4.2rem;" onchange="setFontSize(event)" title="字体大小">
                <option value=24>24px</option>
                <option value=22>22px</option>
                <option value=20>20px</option>
                <option value=18 selected>18px</option>
                <option value=16>16px</option>
                <option value=14>14px</option>
                <option value=12>12px</option>
                <option value=10>10px</option>
                <option value=8 > 8px</option>
            </select>
            <label title="显示行号" class="check-box">
                <input type="checkbox" id="check-lineno" onclick="checkLineNo(this)" checked>LineNo</label>
            <label title="显示 tab 和结尾符" class="check-box">
                <input type="checkbox" id="check-tab" onclick="checkTabShow(this)">ShowTab</label>
            <label title="长行自动换行" class="check-box">
                <input type="checkbox" id="check-wrap" onclick="checkWrap(this)" checked>WrapOverflow</label>
            <label title="感知字母大小写" class="check-box">
                <input type="checkbox" id="check-case" onclick="checkCase(this)" checked>MatchCase</label>
        </div>
        <div class="popup" id="popup-info"></div>
        <div class="editor-container">
            <div id="button-list-left">
                <ul>
                    <li>
                        <button class="button" onclick="convertUpperCase()" title="全大写">
                            <i class="fa-sharp fa-solid fa-u fa-2x"></i>
                        </button>
                    </li>
                    <li>
                        <button class="button" onclick="convertLowerCase()" title="全小写">
                            <i class="fa-sharp fa-solid fa-l fa-2x"></i>
                        </button>
                    </li>
                    <li>
                        <button class="button" onclick="convertTitleCase()" title="词首大写">
                            <i class="fa-sharp fa-solid fa-t fa-2x"></i>
                        </button>
                    </li>
                    <li>
                        <button class="button" onclick="convertSentenceCase()" title="句首大写">
                            <i class="fa-sharp fa-solid fa-s fa-2x"></i>
                        </button>
                    </li>
                    <li>
                        <button class="button" onclick="convertInverseCase()" title="大小写反转">
                            <i class="fa-sharp fa-solid fa-i fa-2x"></i>
                        </button>
                    </li>
                </ul>
            </div>
            <div class="editor" id="text1">
                <textarea id="code" name="code">
I guess it comes down to a simple choice, really. Get busy living or get busy dying.

You got a dream, you gotta protect it. People can't do something themselves, they wanna tell you you can't do it. If you want something, go get it. 

Life was like a box of chocolates, you never know what you're gonna get.

- Is life always this hard, or is it just when you're a kid? 
- Always like this.

People should not be afraid of their governments. Governments should be afraid of their people.

Now I have come to the crossroads in my life. I always knew what the right path was. Without exception, I knew, but I never took it. You know why? It was too damn hard.

You're not your job. You're not how much money you have in the bank. You're not the car you drive. You're not the contents of your wallet. You're not your fucking khakis. You are the all-singing, all-dancing crap of the world.

Easy doesn't enter into grown-up life.

Family. Family. Family comes first.

Life isn't like in the movies.
Life... is much harder.

Good morning, and in case I don't see you, good afternoon, good evening, and good night.

Tomorrow is another day.

Each, in its own way, was unforgettable. It would be difficult to -- Rome! By all means, Rome. I will cherish my visit here in memory as long as I live.

Happiness is not about being immortal nor having food or rights in one's hand. It's about having each tiny wish come true, or having something to eat when you are hungry or having someone's love when you need love.

We all live in the past. We take a minute to know someone, one hour to like someone, and one day to love someone, but the whole life to forget someone.

Many that live deserve death, some that die deserve life.

Do you still remember the situation in Charles? Spring is approaching, trees and fruits are blooming, birds are building nests in shrubs, and summer wheat is sown in the lowlands.
                </textarea>
            </div>
            <div class="resizer fa-solid fa-ellipsis-vertical fa-1x" id="resizer"></div>
            <div class="viewer" id="text2">
                <div class="lineno-container">
                    <div class="lineno" id="line-no"></div>
                </div>
                <div class="view-text" id="view" name="view"></div>
            </div>
            <div id="button-list-right">
                <ul>
                    <li>
                        <button class="button fa-solid fa-bold fa-2x" onclick="changeFontWeight()" title="字体加粗"></button>
                        <div class="icon-name">Bold</div>
                    </li>
                    <li>
                        <button class="button fa-solid fa-crosshairs fa-2x" onclick="pickMatch()" title="仅保留匹配的字符"></button>
                        <div class="icon-name">Pick</div>
                    </li>
                    <li>
                        <button class="button fa-solid fa-chart-column fa-2x" onclick="countChar()" ondblclick="countWord()" title="单击统计字符，双击统计词"></button>
                        <div class="icon-name">Count</div>
                    </li>
                    <li>
                        <button class="button fa-solid fa-paste fa-2x" id="paste" title="粘贴剪切板的文本到输入框"></button>
                        <div class="icon-name">Paste</div>
                    </li>
                    <li>
                        <button class="button fa-solid fa-copy fa-2x" id="copy" data-clipboard-target="#view" title="复制"></button>
                        <div class="icon-name">Copy</div>
                    </li>
                    <li>
                        <button class="button fa-solid fa-broom fa-2x" onclick="clearText()" title="清空文本框"></button>
                        <div class="icon-name">Clear</div>
                    </li>
                </ul>
            </div>
        </div>
        <div class="input-container">
            <div class="inputer">
                <input type="text" id="input3" oninput="filterLine(this)" placeholder="filter" onfocus="this.placeholder=''" onblur="this.placeholder='filter'">
                <div class="match-info" id="match">
                    <i class="button fa-solid fa-caret-left fa-lg" onclick="findPreviousMatch()"></i>
                    <span id="match-cnt"></span>
                    <i class="button fa-solid fa-caret-right fa-lg" onclick="findNextMatch()"></i>
                </div>
            </div>
            <div class="inputer" style="width:5%">
                <button class="button fa-solid fa-square-minus fa-1x" onclick="clearInput()" title="清空输入框"></button>
            </div>
            <div class="inputer">
                <input type="text" id="input1" oninput="toReplace(this)" placeholder="find" onfocus="this.placeholder=''" onblur="this.placeholder='find'">
                <input type="text" id="input2" oninput="replaceTo(this)" placeholder="replace" onfocus="this.placeholder=''" onblur="this.placeholder='replace'">
            </div>
        </div>
        <script>
            const area1 = document.getElementById("text1");
            const area2 = document.getElementById("text2");
            const viewer = document.getElementById("view");
            const selectInfo = document.getElementById("select-cnt");
            const tabCheck = document.getElementById("check-tab");
            const wrapper = document.getElementById("check-wrap");
            const lnCheck = document.getElementById("check-lineno");
            const lineno = document.getElementById("line-no");
            const matchInfo = document.getElementById("match");
            const matchCntInfo = document.getElementById("match-cnt");
            const input1 = document.getElementById("input1");
            const input2 = document.getElementById("input2");
            const input3 = document.getElementById("input3");
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            const viewStyles = window.getComputedStyle(viewer);

            const editor = CodeMirror.fromTextArea(document.getElementById('code'), {
                lineNumbers: true,
                lineWrapping: true,
                scrollbarStyle: "overlay",
                indentUnit: 4,
                tabSize: 4,
                indentWithTabs: false,
                mode: 'text/plain',
                matchBrackets: true,
                theme: 'eclipse',
                maxHighlightLength: Infinity,
                styleActiveLine: true,
                foldGutter: true,
                gutters:["CodeMirror-linenumbers", "CodeMirror-foldgutter"],
                extraKeys: {
                    "Ctrl-B": function(cm) {
                        cm.setOption("fullScreen", !cm.getOption("fullScreen"));
                    },
                    "F11": function(cm) {
                        cm.setOption("fullScreen", !cm.getOption("fullScreen"));
                    },
                    "Esc": function(cm) {
                        if(cm.getOption("fullScreen")) cm.setOption("fullScreen", false);
                    }
                }
            });
            editor.on('change', () => {
                showNewLine();
                replace();
            });
            editor.on('focus', () => {
                area1.style.border = "2px solid rgba(11, 58, 77, 0.8)";
            });
            editor.on('blur', () => {
                area1.style.border = "2px solid rgba(39, 64, 101, 0.3)";
            });
            editor.on('scroll', () => {
                showNewLine();
            });
            function setLangMode(event) {
                var mode = event.target.value;
                editor.setOption("mode", mode);
            }
            function setTheme(event) {
                var theme = event.target.value;
                editor.setOption("theme", theme);
            }
            function setFontSize(event) {
                var fs = event.target.value;
                viewer.style.fontSize = fs + "px";
                lineno.style.fontSize = fs + "px";
                editor.getWrapperElement().style["font-size"] = fs + "px";
                editor.refresh();
                context.font = `${viewStyles.fontSize} ${viewStyles.fontFamily}`;
                addLineNo();
            }

            function countAndSort(text) {
                var json = text.reduce((map, char) => {
                    if (matchCase == "i") char = char.toLowerCase();
                    map[char] = (map[char] || 0) + 1;
                    return map;
                }, {});
                var items = Object.keys(json).map((key) => {
                    return [key, json[key]];
                });
                items.sort((l, r) => {
                    return (r[1] - l[1]) > 0? 1: ((r[1] - l[1]) == 0? (r[0] <= l[0]? 1: -1): -1)});
                var sortKeys = [];
                for (var i in items) sortKeys.push(items[i][0]);
                return JSON.stringify(json, sortKeys, 4);
            }
            function countChar() {
                var text = editor.getDoc().getValue("\n").split("");
                viewer.innerText = countAndSort(text);
                addLineNo();
            }
            function countWord() {
                var text = editor.getDoc().getValue("\n").match(/[-+.0-9]+|[-'_0-9a-zA-Z]+/g);
                if (text) viewer.innerText = countAndSort(text);
                else viewer.innerText = "{}";
                addLineNo();
            }

            function clearInput() {
                input1.value = "";
                input2.value = ""; 
                input3.value = ""; 
                toReplace(input1);
                replaceTo(input2);
                filterLine(input3);
            }
            var toReplaceStr = "";
            function toReplace(ele) {
                toReplaceStr = ele.value;
                ele.style.width = (ele.value.length + 10) + "ch";
                replace();
            }

            var matchStr = ".";
            function markMatch() {
                clearMark();
                var cursor = editor.getSearchCursor(
                    new RegExp(matchStr, "gm" + matchCase), 
                    CodeMirror.Pos(editor.firstLine(), 0), 
                    {caseFold: true, multiline: true});
                var cnt = 0;
                while(cursor.findNext()) {
                    cnt += 1;
                    editor.markText(cursor.from(), cursor.to(), {className: 'match-highlight'});
                }
                return cnt;
            }
            function clearMark() {
                editor.doc.getAllMarks().forEach(m => m.clear());
                markId = -1;
            }
            // cm operation 加速
            function cmMark(target) {
                matchStr = target;
                return editor.operation(markMatch);
            }
            function cmClear() {
                editor.operation(clearMark);
            }

            var markId = -1;
            function findPreviousMatch() {
                var marks = editor.doc.getAllMarks();
                if (markId < 0) markId = 0;
                markId = (markId - 1 + marks.length) % marks.length;
                if (markId < marks.length) {
                    var pos = marks[markId].find();
                    editor.setSelection(pos.from, pos.to);
                    editor.scrollIntoView(pos.from, 20);
                }
            }
            function findNextMatch() {
                var marks = editor.doc.getAllMarks();
                markId = (markId + 1) % marks.length;
                if (markId < marks.length) {
                    var pos = marks[markId].find();
                    editor.setSelection(pos.from, pos.to);
                    editor.scrollIntoView(pos.from, 20);
                }
            }
            
            var replaceToStr = "";
            function replaceTo(ele) {
                replaceToStr = ele.value;
                ele.style.width = (ele.value.length + 10) + "ch";
                replaceToStr = replaceToStr.replace(/\\n/g, "@NEWLINE@");
                replace();
            }

            function placeholderRecover() {
                viewer.innerHTML = viewer.innerHTML.replace(/@NEWLINE@/g, "<br>");
            }

            function applyCustomCaseRE() {
                var h = viewer. innerHTML;
                h = h.replace(/\\U((?!\\U||\\L).)*\\U/g, (s) => { return s.replace(/\\U/g, "").toUpperCase()});
                h = h.replace(/\\L((?!\\U||\\L).)*\\L/g, (s) => { return s.replace(/\\L/g, "").toLowerCase()});
                viewer .innerHTML = h;
            }

            function isMatch(src, tgt) {
                return src.match(new RegExp(tgt));
            }

            var filterStr = "";
            function filterLine(ele) {
                filterStr = ele.value;
                ele.style.width = (ele.value.length + 10) + "ch";
                replace();
            }

            function filterText(text) {
                var matchCnt = cmMark(filterStr);
                if (filterStr.length == 0) {
                    hideFilterInfo();
                    return text;
                }
                var lines = text.split("\n");
                var result = [];
                var re = new RegExp(htmlEscape(filterStr), "gm" + matchCase);
                lines.forEach(line => {
                    if (line.match(re)) result.push(line);
                });
                var lineCnt = result.length;
                if (filterStr == "\\n") {
                    lineCnt = lines.length - 1;
                    result = text;
                } else {
                    result = result.join("\n");
                }
                showFilterInfo(matchCnt, lineCnt);
                return result;
            }

            function hideFilterInfo() {
                matchInfo.style.opacity = "0";
            }
            function showFilterInfo(matchCnt, lineCnt) {
                matchInfo.style.opacity = "1";
                matchCntInfo.innerText = lineCnt + " Line" + (lineCnt > 1? "s, ": ", ") + 
                    matchCnt + " Hit" + (matchCnt > 1? "s": "");
            }
            function showReplaceInfo(re, text, total) {
                const replaceCnt = ((text || "").match(re) || []).length;
                matchCntInfo.innerText = matchCntInfo.innerText + 
                    ", " + replaceCnt + "/" + total + " Replaced";
            }

            function pickMatch() {
                const lines = viewer.innerHTML.split("\n");
                var targets = [];
                for (var i in lines) {
                    var m = lines[i].match(/<span class="replacement">[^<]+<\/span>/g);
                    if (m) targets.push(m.join("\t")); // 行内用 \t 分割
                    else targets.push("\t");
                }
                viewer.innerHTML = targets.join("\n");
                wrapper.checked = false;
                checkWrap(wrapper);
                addLineNo();
            }
            
            function formatPre(text) {
                return text;
                // return "<pre style='padding:0;margin:0'>" + text + "</pre>";
            }

            function htmlEscape(text) {
                return text.replace(/</g,'&lt;').replace(/>/g,'&gt;');
            }
            
            function replace() {
                try {
                    var text = htmlEscape(editor.getDoc().getValue("\n"));
                    if (filterStr == "") {
                        if (toReplaceStr != "") {
                            filterStr = toReplaceStr;
                            input3.placeholder = filterStr;
                            filterText(text);
                            filterStr = "";
                        } else {
                            cmClear();
                            input3.placeholder = "filter";
                            hideFilterInfo();
                        }
                    } else {
                        text = filterText(text);
                    }
                    viewer.innerHTML = formatPre(text);
                    if (toReplaceStr.length > 0) {
                        const total = cmMark(toReplaceStr);
                        var re = new RegExp(htmlEscape(toReplaceStr), "gm" + matchCase);
                        showReplaceInfo(re, text, total);
                        text = text.replace(re, "<span class='replacement'>" + replaceToStr + "</span>");
                        viewer.innerHTML = formatPre(text);
                        applyCustomCaseRE();
                        placeholderRecover();
                    } else {
                        if (filterStr != "") {
                            var re = new RegExp(htmlEscape(filterStr), "gm" + matchCase);
                            text = text.replace(re, "<span class='replacement'>$&</span>");
                            viewer.innerHTML = formatPre(text);
                        }
                    }
                    addLineNo();
                } catch (e) {
                    filterStr = input3.value;
                    reportError(e);
                }
            }
            
            var needShowN = false;
            function checkTabShow(obj) {
                if (obj.checked) {
                    editor.setOption("indentWithTabs", true);
                    $("#tab-style").html(".cm-tab{opacity: 0.5}");
                    needShowN = true;
                } else {
                    editor.setOption("indentWithTabs", false);
                    $("#tab-style").html(".cm-tab{opacity: 0}");
                    needShowN = false;
                }
                showNewLine();
            }
            function showNewLine() {
                if (needShowN) $("pre.CodeMirror-line").addClass("newline");
                else $("pre.CodeMirror-line").removeClass("newline");
            }
            
            function checkWrap(obj) {
                if (obj.checked) {
                    // area2.style.display = "block";
                    viewer.classList.remove("text-nowrap");
                    viewer.classList.add("text-wrap");
                    editor.setOption("lineWrapping", true);
                    // lnCheck.checked = false;
                    // checkLineNo(lnCheck);
                } else {
                    viewer.classList.remove("text-wrap");
                    viewer.classList.add("text-nowrap");
                    editor.setOption("lineWrapping", false);
                }
                addLineNo();
            }
            function forceWrap() {
                viewer.classList.remove("text-nowrap");
                viewer.classList.add("text-wrap");
            }

            var matchCase = "";
            function checkCase(obj) {
                if (obj.checked) matchCase = "";
                else matchCase = "i";
                replace();
            }

            var showLineNo = true;
            function checkLineNo(obj) {
                if (obj.checked) {
                    // wrapper.checked = false;
                    // checkWrap(wrapper);
                    showLineNo = true;
                    area2.style.display = "flex";
                } else {
                    lineno.style.display = "none";
                    showLineNo = false;
                    area2.style.display = "block";
                }
                addLineNo();
            }
            function addLineNo() {
                if (!showLineNo) return;
                
                const n = viewer.innerText.split("\n").length;
                lineno.style.width = n.toString().length * 13 + "px";
                lineno.style.height = (viewer.scrollHeight + 50) + "px";
                lineno.style.display = "block";
                
                var h = "";
                if (wrapper.checked) {
                    var lineNumbers = calcLines();
                    h = lineNumbers.join("<br>") + "<br>";
                } else {
                    for (var i = 1; i <= n; ++i) {
                        h += i + "<br>";
                    }
                }
                lineno.innerHTML = h;
            }

            var isBoldFont = true;
            function changeFontWeight() {
                if (isBoldFont) {
                    viewer.classList.remove('bold-font');
                    viewer.classList.add('normal-font');
                } else {
                    viewer.classList.remove('normal-font');
                    viewer.classList.add('bold-font');
                }
                isBoldFont = !isBoldFont;
            }
            function clearText() {
                editor.setValue("");
                replace();
            }
            var isOnView = false;
            area1.addEventListener("mouseenter", function(){
                isOnView = false;
            });
            area2.addEventListener("mouseenter", function(){
                isOnView = true;
            });
            viewer.addEventListener("mouseenter", function(){
                isOnView = true;
            });
            document.addEventListener("mouseup", function(){
                const s = window.getSelection().toString();
                const len = s.length;
                const ws = (s.match(/\s/gm) || []).length; // 空白字符 whitespace
                const lines = s.split("\n");
                var ln = lines.length;
                if (lines[ln - 1] == "") ln -= 1;
                if (len > 0) {
                    selectInfo.style.display = "block";
                    selectInfo.innerText = len + " Char" + (len > 1? "s": "") + ", " +
                        ws + " WS, " + ln + " Line" + (ln > 1? "s": "");
                } else {
                    selectInfo.style.display = "none";
                }
            });
            document.addEventListener("keydown", function(event) {
                var textarea = document.getElementById('text2');
                // 光标在 viewer 文本框才触发全屏快捷键
                if (isOnView && (event.key == "F11" || (event.ctrlKey && (event.key == 'b' || event.key == 'B')))) {
                    if (event.key == "F11") event.preventDefault();
                    console.log("fullscreen");
                    textarea.classList.toggle("fullscreen");
                }
                if (textarea.classList.contains("fullscreen")) {
                    if (event.key == "Escape") {
                        console.log("exit fullscreen");
                        textarea.classList.toggle("fullscreen");
                    }
                }
            });
            
            // 监听 copy 行为，拷贝文本后处理
            document.addEventListener('copy', (event) => {
                var toCopy = document.getSelection().toString();
                // 把 html 的 &nbsp; 替换回空格
                var toPaste = toCopy.replace(/\u00A0/g, " ");
                event.clipboardData.setData('text/plain', toPaste);
                event.preventDefault();
            });
            const clipboard = new ClipboardJS('.button');
            
            function popElement(info, boxName, pos, timeout) {
                var box = document.getElementById(boxName);
                var boxRect = box.getBoundingClientRect();
                var popup = document.getElementById("popup-info");
                popup.style.display = 'flex';
                popup.innerText = info;
                var ppRect = popup.getBoundingClientRect();
                if (pos === "under") {
                    popup.style.top = boxRect.bottom + 20 + "px";
                    popup.style.left = boxRect.left - (ppRect.width - boxRect.width) / 2 + "px";
                } else if (pos === "center") {
                    popup.style.top = boxRect.top + (boxRect.height - ppRect.height) / 2 + "px";
                    popup.style.left = boxRect.left - (ppRect.width - boxRect.width) / 2 + "px";
                }
                setTimeout(() => {
                    popup.style.display = 'none';
                }, timeout);
            }
            clipboard.on('success', function(event) {
                event.clearSelection();
                popElement("复制完成", "text2", "center", 1000);
            });
            clipboard.on('error', function(event) {
                console.log('复制失败 ' + event.action);
                popElement("复制失败", "text2", "center", 1000);
            });
            document.getElementById("paste").addEventListener(
                "click",
                async(e) => {
                    const text = await navigator.clipboard.readText();
                    editor.setValue(text);
                    popElement("粘贴完成", "text1", "center", 500);
                }
            );
            // resize 
            var startX; var startWidth1; var startWidth2;
            const resizer = document.getElementById('resizer');
            const text1 = resizer.previousElementSibling;
            const text2 = resizer.nextElementSibling;
            resizer.addEventListener('mousedown', function (e) {
                startX = e.clientX;
                startWidth1 = text1.offsetWidth;
                startWidth2 = text2.offsetWidth;
                document.documentElement.addEventListener('mousemove', resize, false); 
                document.documentElement.addEventListener('mouseup', stopResize, false);
            });
            function resize(e) {
                const delta = e.clientX - startX;
                const newWidth1 = startWidth1 + delta;
                const newWidth2 = startWidth2 - delta;
                text1.style.width = newWidth1 + 'px';
                text2.style.width = newWidth2 + 'px';
                addLineNo();
                // 触发 scrollbar
                editor.refresh();
            }
            function stopResize() {
                document.documentElement.removeEventListener('mousemove', resize, false); 
                document.documentElement.removeEventListener('mouseup', stopResize, false);
            }

            // case converter
            function convertUpperCase() {
                viewer.innerText = formatPre(editor.getValue().toUpperCase());
            }
            function convertLowerCase() {
                viewer.innerText = formatPre(editor.getValue().toLowerCase());
            }
            function convertSentenceCase() {
                var result = htmlEscape(editor.getDoc().getValue("\n")).toLowerCase().replace(/^(\s*)(\w)/gm, (...args) => {
                    return args[1] + "<span class='replacement'>" + args[2].toUpperCase() + "</span>"
                });
                result = result.replace(/(?<=\w\.|!|\?)(\s*)(\w)/g, (...args) => {
                    return args[1] + "<span class='replacement'>" + args[2].toUpperCase() + "</span>"
                });
                result = result.replace(/\bi\b/g, "I");
                result = result.replace(/^- ([a-z])/gm, (...args) => {
                    return "- <span class='replacement'>" + args[1].toUpperCase() + "</span>"
                });
                viewer.innerHTML = result;
            }
            function convertTitleCase() {
                var result = editor.getDoc().getValue("\n").toLowerCase();
                result = result.replace(/([a-zA-Z][_'\-a-zA-Z0-9]*)/g, function(word) {
                    return "<span class='replacement'>" + word.charAt(0).toUpperCase() + "</span>" + word.slice(1);
                });
                viewer.innerHTML = result;
            }
            function convertInverseCase() {
                var origin_txt = editor.getValue();
                var result = '';
                var i = 0;
                while (i < origin_txt.length) {
                    var n = origin_txt.charAt(i);
                    if (n == n.toLowerCase()) {
                        result += n.toUpperCase();
                    } else if (n == n.toUpperCase()) {
                        result += n.toLowerCase();
                    } else {
                        result += n;
                    }
                    i += 1;
                }
                viewer.innerText = formatPre(result);
            }

            function calcStringLines(sentence, width) {
                if (!width) return 0;
                const words = sentence.split('');
                let lineCount = 0;
                let currentLine = '';
                for (let i = 0; i < words.length; i++) {
                    const wordWidth = context.measureText(words[i]).width;
                    const lineWidth = context.measureText(currentLine).width;
                    if (lineWidth + wordWidth > width) {
                        lineCount++;
                        currentLine = words[i];
                    } else {
                        currentLine += words[i];
                    }
                 }
                 // if (currentLine.trim() !== '') lineCount++;
                 lineCount++;
                 return lineCount;
            }
            
            function calcLines() {
                const lines = viewer.innerText.split('\n');
                const textareaContentWidth = $("#view").width();
                const numLines = lines.map(
                    lineString => calcStringLines(lineString, textareaContentWidth));
                let lineNumbers = [];
                let i = 1;
                while (numLines.length > 0) {
                    const numLinesOfSentence = numLines.shift();
                    lineNumbers.push(i);
                    if (numLinesOfSentence > 1) { 
                        Array(numLinesOfSentence - 1)
                           .fill('')
                           .forEach((_) => lineNumbers.push(''));
                    }
                    i++;
                }
                return lineNumbers;
            }

            window.onerror = function(message, source, lineno, colno, error) {
                viewer.innerHTML = "<pre class='error'>" + error + "</pre>";
                viewer.innerHTML += "<pre class='error'>" + "Line: " + lineno + ", Column: " + colno + "</pre>";
            };

            function init() {
                context.font = `${viewStyles.fontSize} ${viewStyles.fontFamily}`;
                forceWrap();
                checkLineNo(lnCheck);
                replace();
            }

            window.addEventListener("load", init);
        </script>
        <style id="tab-style">
            .cm-tab{opacity: 0;}
        </style>
    </body>
</html>
